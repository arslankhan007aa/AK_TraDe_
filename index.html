<!DOCTYPE html>
<html>
<head>
<title>AK Trade ‚Äî Full System (Firebase)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  background: linear-gradient(180deg,#001F3F,#000);
  color:#fff;
  font-family:sans-serif;
  margin:0;
  padding-bottom:90px;
}
.box{
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(6px);
  padding:20px;
  border-radius:14px;
  margin:15px;
  box-shadow:0 0 12px #00A8FF55;
}
input, select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #00A8FF;
  background:#00111F;
  color:#fff;
  margin-top:10px;
}
input[type="file"]{
    border: none;
    padding: 0;
    margin-top: 15px;
}
button{
  width:100%;
  padding:12px;
  background:#00A8FF;
  color:#fff;
  border:none;
  border-radius:10px;
  margin-top:10px;
  font-size:17px;
  font-weight:600;
  box-shadow:0 0 10px #00A8FFAA;
  transition: background 0.3s;
}
button:hover { background: #007BFF; }
button:disabled {
    background: #555 !important;
    box-shadow: none;
    cursor: not-allowed;
}
h2{ 
  color:#00C8FF; 
  font-weight:700;
  margin-top: 0;
}
.plan-btn {
    background: #009933;
    box-shadow: 0 0 10px #00AA00AA;
    margin-top: 5px;
}
nav{
text-align:center;
padding:18px 0;
background:#000;
position:fixed;
bottom:0;
left:0;
right:0;
z-index:999;
box-shadow:0 -3px 10px #00A8FF55;
}
nav a{
color:#00C8FF;
margin:0 14px;
font-size:18px;
text-decoration:none;
font-weight:600;
}
nav .channelBtn{
  color:#fff;
  background:#00A8FF;
  padding:6px 12px;
  border-radius:8px;
}
.hidden{ display:none; }
</style>
</head>
<body onload="checkUserStatus()">

<div id="loginPage">
  <div class="box">
    <h2>Login üîë</h2>
    <button onclick="showSignup()">Create Account</button>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" placeholder="Password" type="password">
    <button onclick="login()">Login</button>
  </div>
</div>

<div id="signupPage" class="hidden">
  <div class="box">
    <h2>Create Account ‚úçÔ∏è</h2>
    <input id="newUser" placeholder="Username">
    <input id="newPass" placeholder="Password" type="password">
    <input id="refBy" placeholder="Referral Username (Optional)">
    <button onclick="signup()">Create Account</button>
    <button onclick="showLogin()">Back to Login</button>
  </div>
</div>

<div id="dashboard" class="hidden">

<div class="box">
  <h2>Dashboard üè†</h2>
  <p id="welcome"></p>
  <p id="bal">Balance: 0 Rs</p>
  <p id="planName">Active Plan: None</p>
  <p id="planExpiry">Plan Expiry: ‚Äî</p>
</div>

<div id="deposit" class="box hidden">
  <h2>Deposit üí∏</h2>
  <p style="color:#00C8FF;">**Note:** Buy a plan in 'Plan' section first.</p>
  <select id="depositType">
    <option>JazzCash</option>
    <option>Easypaisa</option>
  </select>
  <input id="depositAmount" placeholder="Enter Deposit Amount (Auto-filled by Plan)">
  <p style="margin-top:10px;">Upload Payment Screenshot:</p>
  <input type="file" id="ssUpload" accept="image/*">
  <p style="margin-top:15px;background:#00111F;padding:12px;border-radius:10px;">
    Pay to: <b>03046416033 (Ghulam Ruqayya)</b>
  </p>
  <button onclick="depositReq()">Submit Deposit</button>
</div>

<div id="withdraw" class="box hidden">
  <h2>Withdraw üèß</h2>
  <p style="color:yellow;">Available Balance: <b id="availableBal">0 Rs</b></p>
  <select id="widType">
    <option>JazzCash</option>
    <option>Easypaisa</option>
  </select>
  <input id="widNum" placeholder="Your Number">
  <input id="widName" placeholder="Your Name">
  <input id="widAmount" placeholder="Amount (Min 10 Rs)">
  <button onclick="withdrawReq()">Submit Withdraw</button>
</div>

<div id="task" class="box hidden">
  <h2>Daily Task ‚≠ê</h2>
  <p>Watch this video for 15 seconds to collect your daily income.</p>
  <p id="taskTimer" style="color:red; font-weight:bold;">Task Status: Ready to start.</p>

  <a id="tiktokLink" href="https://vt.tiktok.com/ZSf6ECxjw/" target="_blank">
    <button id="startTaskBtn" onclick="startTaskTimer(event)">Start Watching TikTok (15 Sec)</button>
  </a>
  <button id="collectTaskBtn" onclick="completeTask()" disabled style="background:#888;">Collect Bonus</button>
</div>

<div id="referral" class="box hidden">
  <h2>Referral üßë‚Äçü§ù‚Äçüßë</h2>
  <p>Your Username: <b id="refName"></b></p>
  <p>Your Referral Link:</p>
  <p style="background:#00111F;padding:10px;border-radius:8px;">
    aktrade.com/?ref=<span id="refLink"></span>
  </p>
</div>

<div id="plan" class="box hidden">
  <h2>Plans üíé</h2>
  <div style="background:#00111F;padding:12px;border-radius:12px;margin-bottom:12px;">
    <b>Plan 1:</b> Deposit 200 ‚Üí Daily 10Rs ‚Üí 50 Days    
    <button class="plan-btn" onclick="selectPlan(200,10, 'Plan 1')">Buy Plan 1</button>
  </div>
  <div style="background:#00111F;padding:12px;border-radius:12px;margin-bottom:12px;">
    <b>Plan 2:</b> Deposit 600 ‚Üí Daily 35Rs ‚Üí 50 Days    
    <button class="plan-btn" onclick="selectPlan(600,35, 'Plan 2')">Buy Plan 2</button>
  </div>
  <div style="background:#00111F;padding:12px;border-radius:12px;margin-bottom:12px;">
    <b>Plan 3:</b> Deposit 1200 ‚Üí Daily 80Rs ‚Üí 50 Days    
    <button class="plan-btn" onclick="selectPlan(1200,80, 'Plan 3')">Buy Plan 3</button>
  </div>
</div>

<div id="profile" class="box hidden">
  <h2>Profile üë§</h2>
  <p>Username: <b id="proUser"></b></p>
  <p>Balance: <b id="proBal"></b></p>
  <button onclick="logout()">Logout</button>
</div>

</div>

<nav id="navBar" class="hidden">
  <a onclick="showSection('deposit')">Deposit</a>
  <a onclick="showSection('withdraw')">Withdraw</a>
  <a onclick="showSection('task')">Task</a>
  <a onclick="showSection('referral')">Referral</a>
  <a onclick="showSection('plan')">Plan</a>
  <a onclick="showSection('profile')">Profile</a>
  <a class="channelBtn" href="https://whatsapp.com/channel/0029Vb6rV2aL7UVYj5WZvi3y" target="_blank">Channel</a>
</nav>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
import { getDatabase, ref, set, get, child, update, onValue, push } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCVcdtynCplhZkLvqLJer99z3PHb6W2VEs",
  authDomain: "ak-trade-f8c93.firebaseapp.com",
  databaseURL: "https://ak-trade-f8c93-default-rtdb.firebaseio.com",
  projectId: "ak-trade-f8c93",
  storageBucket: "ak-trade-f8c93.firebasestorage.app",
  messagingSenderId: "873979008978",
  appId: "1:873979008978:web:70564474ef8f09fd059a0b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app); 
const dbRef = ref(db);
let currentUser = null; 
let taskInterval = null; 
const TASK_DURATION_MS = 15000;

function checkUserStatus() {
    const storedUser = localStorage.getItem("currentUser");
    if (storedUser) {
        currentUser = storedUser;
        loadDashboard();
    } else {
        showLogin();
    }
}
window.checkUserStatus = checkUserStatus;

async function signup(){
  let u = newUser.value.trim();
  let p = newPass.value.trim();
  let r = refBy.value.trim();

  if(!u || !p) return alert("Username and Password are REQUIRED!");

  if(r && r !== "admin") {
      const refSnapshot = await get(child(dbRef, 'users/' + r));
      if(!refSnapshot.exists()) return alert("Referral username does NOT exist!");
  }

  const userSnapshot = await get(child(dbRef, 'users/' + u));
  if(userSnapshot.exists()) return alert("User already exists");

  const userData = {
    pass: p, bal: 10, plan: null, daily: 0, planExpiry: null, ref: r || null,
    pendingDeposit: null, adminApproved: false, tasksDone: 0, lastTaskDay: null
  };
  
  try {
      await set(ref(db, 'users/' + u), userData);
      alert("Account created! 10 Rs Bonus Added. Please Login.");
      showLogin();
  } catch(error) {
      alert("Signup failed: " + error.message);
  }
}
window.signup = signup;

async function login(){
  let u = loginUser.value.trim();
  let p = loginPass.value.trim();

  const snapshot = await get(child(dbRef, 'users/' + u));
  
  if(!snapshot.exists() || snapshot.val().pass !== p) return alert("Login Failed: Incorrect Username or Password.");

  currentUser = u;
  localStorage.setItem("currentUser", u); 
  loadDashboard();
}
window.login = login;

function loadDashboard(){
    if(!currentUser) return showLogin();
    const userRef = ref(db, 'users/' + currentUser);
    onValue(userRef, (snapshot) => {
        if (!snapshot.exists()) { logout(); return; }
        let d = snapshot.val();

        if(d.adminApproved && d.pendingDeposit){ activatePlanNow(d); return; }
        
        welcome.innerHTML = "Welcome, <b>" + currentUser + "</b>";
        bal.innerHTML = "Balance: <b>" + d.bal + " Rs</b>";
        planName.innerHTML = "Active Plan: <b>" + (d.plan ? d.plan : "None") + "</b>";
        planExpiry.innerHTML = "Plan Expiry: <b>" + (d.planExpiry ? d.planExpiry : "‚Äî") + "</b>";
        refName.innerHTML = currentUser;
        refLink.innerHTML = currentUser;
        proUser.innerHTML = currentUser;
        proBal.innerHTML = d.bal + " Rs";
        availableBal.innerHTML = d.bal + " Rs";
        
        const depositInput = document.getElementById('depositAmount');
        if (d.pendingDeposit) {
            depositInput.value = d.pendingDeposit.amount;
            depositInput.setAttribute('readonly', 'readonly');
        } else {
            depositInput.value = '';
            depositInput.removeAttribute('readonly');
        }

        loginPage.classList.add("hidden");
        signupPage.classList.add("hidden");
        dashboard.classList.remove("hidden");
        navBar.classList.remove("hidden");

        if(loginPage.classList.contains("hidden") && signupPage.classList.contains("hidden")) {
            showSection("deposit");
        }
        updateTaskUI(); 
    }, { onlyOnce: false });
}
window.loadDashboard = loadDashboard; 

function showSection(sec){
  ["deposit","withdraw","task","referral","plan","profile"].forEach(id=>{
    document.getElementById(id).classList.add("hidden");
  });
  document.getElementById(sec).classList.remove("hidden");
}
window.showSection = showSection;

async function selectPlan(amount, dailyIncome, planName){
  if(!currentUser) return alert("Please log in first.");

  const snapshot = await get(child(dbRef, 'users/' + currentUser));
  let d = snapshot.val();

  if (d.plan) return alert("You already have an active plan!");
  if (d.pendingDeposit) return alert("Deposit request pending approval! Check Deposit section.");

  const pendingDepositData = { plan: planName, daily: dailyIncome, amount: amount, method: null, screenshot: null, date: null };
  
  try {
      await update(ref(db, 'users/' + currentUser), { pendingDeposit: pendingDepositData, adminApproved: false });
      alert(`Plan selected. Deposit now to activate.`);
      showSection("deposit");
  } catch(error) {
      alert("Plan selection failed: " + error.message);
  }
}
window.selectPlan = selectPlan;

function depositReq(){
    if(!currentUser) return alert("Please log in first.");

    let amount = depositAmount.value.trim();
    let type = depositType.value;
    let ssFile = ssUpload.files[0]; 

    get(child(dbRef, 'users/' + currentUser)).then(snapshot => {
        let d = snapshot.val();

        if(!d.pendingDeposit) return alert("Select a plan from 'Plan' section first!");
        if(d.pendingDeposit.amount != amount) return alert("Deposit amount must match the selected plan amount (" + d.pendingDeposit.amount + " Rs).");
        if(!ssFile) return alert("Upload the payment screenshot!");

        let reader = new FileReader();
        reader.onload = function(e){
            const updates = { 'pendingDeposit/method': type, 'pendingDeposit/screenshot': e.target.result, 'pendingDeposit/date': new Date().toLocaleString() };
            update(ref(db, 'users/' + currentUser), updates)
            .then(() => { alert("Deposit request sent! Admin will approve soon."); })
            .catch(error => { alert("Deposit request failed: " + error.message); });
        };
        reader.readAsDataURL(ssFile);
    }).catch(error => {
        alert("Failed to fetch user data for deposit: " + error.message);
    });
}
window.depositReq = depositReq;

async function activatePlanNow(d){
    if(!currentUser) return; 
    const now = new Date();
    now.setDate(now.getDate() + 50);
    const planExpiryDate = now.toDateString();
    const updates = { plan: d.pendingDeposit.plan, daily: d.pendingDeposit.daily, planExpiry: planExpiryDate, pendingDeposit: null, adminApproved: false };

    try {
        await update(ref(db, 'users/' + currentUser), updates);
        alert("Your plan has been activated (Admin Approved)!");
    } catch(error) {
        alert("Plan activation failed: " + error.message);
    }
}

async function withdrawReq(){
    if(!currentUser) return alert("Please log in first.");

    let num = widNum.value.trim();
    let name = widName.value.trim();
    let amount = parseInt(widAmount.value.trim());
    let type = widType.value;
    const MIN_WITHDRAW = 10;

    const snapshot = await get(child(dbRef, 'users/' + currentUser));
    let d = snapshot.val();
    
    if (!d.plan) return alert("Buy an active plan first to withdraw.");
    if (isNaN(amount) || amount < MIN_WITHDRAW) return alert("Minimum withdrawal is " + MIN_WITHDRAW + " Rs.");
    if (amount > d.bal) return alert("Request Failed: Insufficient balance. You only have " + d.bal + " Rs.");
    if (!num || !name) return alert("Enter account details.");

    const withdrawalData = { user: currentUser, type: type, number: num, name: name, amount: amount, status: 'Pending', timestamp: new Date().toLocaleString() };
    
    try {
        await push(ref(db, 'withdrawalRequests'), withdrawalData);
        await update(ref(db, 'users/' + currentUser), { bal: d.bal - amount });
        alert(`Withdraw request sent! ${amount} Rs deducted.`);
    } catch(error) {
        alert("Withdrawal failed: " + error.message);
    }
}
window.withdrawReq = withdrawReq;

function startTaskTimer(event) {
    event.preventDefault(); 
    if (localStorage.getItem('task_complete_ready') === 'true') {
        return alert("Already watched! Click 'Collect Bonus'."); 
    }
    
    if (localStorage.getItem('task_started_time')) {
        window.open(document.getElementById('tiktokLink').href, '_blank');
        updateTaskUI();
        return;
    }

    const startTime = Date.now();
    localStorage.setItem('task_started_time', startTime);
    localStorage.removeItem('task_complete_ready');

    window.open(document.getElementById('tiktokLink').href, '_blank');
    updateTaskUI(); 
}
window.startTaskTimer = startTaskTimer;

function updateTaskUI() {
    if (taskInterval) clearInterval(taskInterval);

    const startTime = localStorage.getItem('task_started_time');
    const timerDisplay = document.getElementById('taskTimer');
    const startBtn = document.getElementById('startTaskBtn');
    const collectBtn = document.getElementById('collectTaskBtn');

    if (!startTime || localStorage.getItem('task_complete_ready') === 'true') {
        const isReady = localStorage.getItem('task_complete_ready') === 'true';

        timerDisplay.innerHTML = isReady ? "<span style='color:#00AA00;'>‚úÖ Watched! Collect Bonus Now.</span>" : "Task Status: Ready to start.";
        startBtn.disabled = isReady;
        startBtn.style.background = isReady ? '#555' : '#00A8FF';
        startBtn.innerHTML = isReady ? 'Watched' : 'Start Watching TikTok (15 Sec)';
        collectBtn.disabled = !isReady;
        collectBtn.style.background = isReady ? '#009933' : '#888';
        collectBtn.innerHTML = 'Collect Bonus';

        if(isReady && !startTime) { localStorage.removeItem('task_complete_ready'); updateTaskUI(); } // State correction
        
        if(!isReady && !startTime) {
            get(child(dbRef, 'users/' + currentUser)).then(snapshot => {
                let d = snapshot.val();
                if (d && d.lastTaskDay !== new Date().toDateString()) {
                    localStorage.removeItem('task_started_time');
                    localStorage.removeItem('task_complete_ready');
                }
            }).catch(e => console.error("Error checking user data for task reset:", e));
        }
        return;
    }

    taskInterval = setInterval(() => {
        const elapsedTime = Date.now() - parseInt(startTime);
        const remainingTime = TASK_DURATION_MS - elapsedTime;

        if (remainingTime <= 0) {
            clearInterval(taskInterval);
            localStorage.setItem('task_complete_ready', 'true');
            timerDisplay.innerHTML = "<span style='color:#00AA00;'>‚úÖ Watched! Collect Bonus Now.</span>";
            startBtn.disabled = true; startBtn.style.background = '#555'; startBtn.innerHTML = 'Watched';
            collectBtn.disabled = false; collectBtn.style.background = '#009933'; collectBtn.innerHTML = 'Collect Bonus';
        } else {
            const seconds = Math.ceil(remainingTime / 1000);
            timerDisplay.innerHTML = `‚è≥ Time Remaining: <b style="font-size:1.2em;">${seconds}</b> seconds.`;
            startBtn.disabled = true; startBtn.style.background = '#555'; startBtn.innerHTML = 'Watching...';
            collectBtn.disabled = true; collectBtn.style.background = '#888'; collectBtn.innerHTML = 'Collect Bonus (Waiting...)';
        }
    }, 1000);
}
window.updateTaskUI = updateTaskUI; 

async function completeTask(){
    if(!currentUser) return alert("Please log in first.");
    
    if(localStorage.getItem('task_complete_ready') !== 'true') {
        return alert("Watch the TikTok video for 15 seconds first.");
    }
    
    const snapshot = await get(child(dbRef, 'users/' + currentUser));
    let d = snapshot.val();

    if(!d.plan) return alert("Buy a plan first to earn.");

    const today = new Date().toDateString();
    let updates = {};

    if(d.lastTaskDay !== today){
        updates.tasksDone = 0; updates.lastTaskDay = today;
        localStorage.removeItem('task_started_time'); localStorage.removeItem('task_complete_ready');
        updateTaskUI();
        d.tasksDone = 0;
    }

    if((d.tasksDone || 0) >= 1) return alert("You can only complete 1 task daily!");
    
    if(d.planExpiry && new Date(d.planExpiry) < new Date()) return alert(`Your plan has expired. Buy a new plan.`);

    updates.tasksDone = (d.tasksDone || 0) + 1;
    updates.bal = (d.bal || 0) + d.daily;

    if(d.ref && d.ref !== currentUser){
        const refSnapshot = await get(child(dbRef, 'users/' + d.ref));
        if(refSnapshot.exists()){
            const rd = refSnapshot.val();
            if(rd.plan && (!rd.planExpiry || new Date(rd.planExpiry) > new Date())) {
                const referrerUpdates = { bal: (rd.bal || 0) + 10 };
                await update(ref(db, 'users/' + d.ref), referrerUpdates);
            }
        }
    }

    try {
        await update(ref(db, 'users/' + currentUser), updates);
        alert("Task Completed! +" + d.daily + " Rs Added.");
        
        localStorage.removeItem('task_started_time');
        localStorage.removeItem('task_complete_ready');
        updateTaskUI();

    } catch(error) {
        alert("Task completion failed: " + error.message);
    }
}
window.completeTask = completeTask;

function logout(){
  localStorage.removeItem("currentUser");
  localStorage.removeItem('task_started_time');
  localStorage.removeItem('task_complete_ready');
  currentUser = null;
  location.reload(); 
}
window.logout = logout;

function showSignup(){
  loginPage.classList.add("hidden");
  signupPage.classList.remove("hidden");
}
window.showSignup = showSignup;

function showLogin(){
  signupPage.classList.add("hidden");
  loginPage.classList.remove("hidden");
}
window.showLogin = showLogin;
</script>

</body>
</html>

